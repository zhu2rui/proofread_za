// 删除标注功能实现

// 用户提供的复杂贝塞尔曲线数据
const userBezierData = {
    "samplePoints": [ { "x": "269.00", "y": "380.68" }, { "x": "269.00", "y": "372.08" }, { "x": "272.00", "y": "365.13" }, { "x": "276.15", "y": "358.38" }, { "x": "279.62", "y": "351.07" }, { "x": "285.40", "y": "346.68" }, { "x": "289.34", "y": "340.99" }, { "x": "295.34", "y": "336.34" }, { "x": "301.43", "y": "331.26" }, { "x": "309.26", "y": "329.42" }, { "x": "317.56", "y": "328.68" }, { "x": "326.16", "y": "328.68" }, { "x": "334.76", "y": "328.68" }, { "x": "339.00", "y": "333.62" }, { "x": "341.00", "y": "340.22" }, { "x": "338.86", "y": "346.68" }, { "x": "330.50", "y": "347.68" }, { "x": "321.90", "y": "347.68" }, { "x": "318.00", "y": "341.81" }, { "x": "317.00", "y": "334.21" }, { "x": "319.00", "y": "327.02" }, { "x": "322.02", "y": "320.68" }, { "x": "327.00", "y": "317.06" }, { "x": "333.69", "y": "312.99" }, { "x": "340.94", "y": "309.74" }, { "x": "348.10", "y": "307.68" }, { "x": "355.70", "y": "306.68" }, { "x": "363.30", "y": "305.68" }, { "x": "371.90", "y": "305.68" }, { "x": "380.50", "y": "305.68" }, { "x": "389.10", "y": "305.68" }, { "x": "393.63", "y": "309.99" }, { "x": "396.00", "y": "317.51" }, { "x": "390.57", "y": "320.68" }, { "x": "382.97", "y": "321.68" }, { "x": "374.37", "y": "321.68" }, { "x": "369.00", "y": "317.69" }, { "x": "367.00", "y": "310.51" }, { "x": "368.35", "y": "302.99" }, { "x": "372.72", "y": "297.68" }, { "x": "377.93", "y": "293.75" }, { "x": "383.45", "y": "290.45" }, { "x": "390.46", "y": "287.68" }, { "x": "398.40", "y": "285.68" }, { "x": "406.00", "y": "284.68" }, { "x": "413.60", "y": "305.68" }, { "x": "421.00", "y": "305.68" }, { "x": "428.80", "y": "281.68" }, { "x": "436.40", "y": "280.68" }, { "x": "445.00", "y": "280.68" } ], 
    "bezierCurves": [ [ { "x": "269.00", "y": "380.68" }, { "x": "269.00", "y": "375.52" }, { "x": "268.10", "y": "376.75" }, { "x": "269.00", "y": "372.08" } ], [ { "x": "269.00", "y": "372.08" }, { "x": "269.90", "y": "367.42" }, { "x": "269.86", "y": "369.24" }, { "x": "272.00", "y": "365.13" } ], [ { "x": "272.00", "y": "365.13" }, { "x": "274.14", "y": "361.02" }, { "x": "273.87", "y": "362.60" }, { "x": "276.15", "y": "358.38" } ], [ { "x": "276.15", "y": "358.38" }, { "x": "278.43", "y": "354.16" }, { "x": "276.84", "y": "354.58" }, { "x": "279.62", "y": "351.07" } ], [ { "x": "279.62", "y": "351.07" }, { "x": "282.39", "y": "347.56" }, { "x": "282.49", "y": "349.70" }, { "x": "285.40", "y": "346.68" } ], [ { "x": "285.40", "y": "346.68" }, { "x": "288.32", "y": "343.66" }, { "x": "286.36", "y": "344.10" }, { "x": "289.34", "y": "340.99" } ], [ { "x": "289.34", "y": "340.99" }, { "x": "292.32", "y": "337.89" }, { "x": "291.72", "y": "339.26" }, { "x": "295.34", "y": "336.34" } ], [ { "x": "295.34", "y": "336.34" }, { "x": "298.96", "y": "333.42" }, { "x": "297.25", "y": "333.33" }, { "x": "301.43", "y": "331.26" } ], [ { "x": "301.43", "y": "331.26" }, { "x": "305.60", "y": "329.18" }, { "x": "304.42", "y": "330.19" }, { "x": "309.26", "y": "329.42" } ], [ { "x": "309.26", "y": "329.42" }, { "x": "314.10", "y": "328.64" }, { "x": "312.49", "y": "328.90" }, { "x": "317.56", "y": "328.68" } ], [ { "x": "317.56", "y": "328.68" }, { "x": "322.63", "y": "328.46" }, { "x": "321.00", "y": "328.68" }, { "x": "326.16", "y": "328.68" } ], [ { "x": "326.16", "y": "328.68" }, { "x": "331.32", "y": "328.68" }, { "x": "330.90", "y": "327.20" }, { "x": "334.76", "y": "328.68" } ], [ { "x": "334.76", "y": "328.68" }, { "x": "338.61", "y": "330.16" }, { "x": "337.13", "y": "330.16" }, { "x": "339.00", "y": "333.62" } ], [ { "x": "339.00", "y": "333.62" }, { "x": "340.87", "y": "337.08" }, { "x": "341.04", "y": "336.30" }, { "x": "341.00", "y": "340.22" } ], [ { "x": "341.00", "y": "340.22" }, { "x": "339.86", "y": "343.46" }, { "x": "339.21", "y": "343.30" }, { "x": "338.86", "y": "346.68" } ], [ { "x": "338.86", "y": "346.68" }, { "x": "334.19", "y": "347.28" }, { "x": "334.50", "y": "347.14" }, { "x": "330.50", "y": "347.68" } ], [ { "x": "330.50", "y": "347.68" }, { "x": "326.50", "y": "347.68" }, { "x": "326.50", "y": "347.14" }, { "x": "321.90", "y": "347.68" } ], [ { "x": "321.90", "y": "347.68" }, { "x": "320.21", "y": "345.76" }, { "x": "320.09", "y": "344.28" }, { "x": "318.00", "y": "341.81" } ], [ { "x": "318.00", "y": "341.81" }, { "x": "317.32", "y": "339.43" }, { "x": "317.18", "y": "337.09" }, { "x": "317.00", "y": "334.21" } ], [ { "x": "317.00", "y": "334.21" }, { "x": "317.60", "y": "331.49" }, { "x": "318.46", "y": "329.77" }, { "x": "319.00", "y": "327.02" } ], [ { "x": "319.00", "y": "327.02" }, { "x": "320.32", "y": "323.94" }, { "x": "319.89", "y": "324.34" }, { "x": "322.02", "y": "320.68" } ], [ { "x": "322.02", "y": "320.68" }, { "x": "324.70", "y": "319.00" }, { "x": "325.48", "y": "318.80" }, { "x": "327.00", "y": "317.06" } ], [ { "x": "327.00", "y": "317.06" }, { "x": "330.34", "y": "314.77" }, { "x": "329.88", "y": "315.12" }, { "x": "333.69", "y": "312.99" } ], [ { "x": "333.69", "y": "312.99" }, { "x": "337.32", "y": "311.35" }, { "x": "337.18", "y": "311.35" }, { "x": "340.94", "y": "309.74" } ], [ { "x": "340.94", "y": "309.74" }, { "x": "344.50", "y": "308.58" }, { "x": "344.73", "y": "308.32" }, { "x": "348.10", "y": "307.68" } ], [ { "x": "348.10", "y": "307.68" }, { "x": "351.89", "y": "307.08" }, { "x": "352.00", "y": "306.84" }, { "x": "355.70", "y": "306.68" } ], [ { "x": "355.70", "y": "306.68" }, { "x": "359.39", "y": "306.08" }, { "x": "359.50", "y": "305.84" }, { "x": "363.30", "y": "305.68" } ], [ { "x": "363.30", "y": "305.68" }, { "x": "367.65", "y": "305.48" }, { "x": "367.00", "y": "305.68" }, { "x": "371.90", "y": "305.68" } ], [ { "x": "371.90", "y": "305.68" }, { "x": "376.30", "y": "305.68" }, { "x": "376.30", "y": "305.48" }, { "x": "380.50", "y": "305.68" } ], [ { "x": "380.50", "y": "305.68" }, { "x": "384.70", "y": "305.68" }, { "x": "384.70", "y": "305.48" }, { "x": "389.10", "y": "305.68" } ], [ { "x": "389.10", "y": "305.68" }, { "x": "391.26", "y": "307.57" }, { "x": "391.36", "y": "306.97" }, { "x": "393.63", "y": "309.99" } ], [ { "x": "393.63", "y": "309.99" }, { "x": "395.42", "y": "313.24" }, { "x": "394.87", "y": "313.64" }, { "x": "396.00", "y": "317.51" } ], [ { "x": "396.00", "y": "317.51" }, { "x": "394.34", "y": "318.89" }, { "x": "392.51", "y": "319.38" }, { "x": "390.57", "y": "320.68" } ], [ { "x": "390.57", "y": "320.68" }, { "x": "386.77", "y": "321.18" }, { "x": "386.50", "y": "321.04" }, { "x": "382.97", "y": "321.68" } ], [ { "x": "382.97", "y": "321.68" }, { "x": "378.77", "y": "321.68" }, { "x": "378.77", "y": "321.48" }, { "x": "374.37", "y": "321.68" } ], [ { "x": "374.37", "y": "321.68" }, { "x": "372.39", "y": "320.49" }, { "x": "371.75", "y": "320.29" }, { "x": "369.00", "y": "317.69" } ], [ { "x": "369.00", "y": "317.69" }, { "x": "368.09", "y": "315.87" }, { "x": "367.76", "y": "314.07" }, { "x": "367.00", "y": "310.51" } ], [ { "x": "367.00", "y": "310.51" }, { "x": "367.28", "y": "307.49" }, { "x": "368.23", "y": "306.18" }, { "x": "368.35", "y": "302.99" } ], [ { "x": "368.35", "y": "302.99" }, { "x": "370.39", "y": "300.34" }, { "x": "369.82", "y": "300.33" }, { "x": "372.72", "y": "297.68" } ], [ { "x": "372.72", "y": "297.68" }, { "x": "375.42", "y": "295.90" }, { "x": "375.06", "y": "295.63" }, { "x": "377.93", "y": "293.75" } ], [ { "x": "377.93", "y": "293.75" }, { "x": "380.74", "y": "291.90" }, { "x": "380.51", "y": "291.68" }, { "x": "383.45", "y": "290.45" } ], [ { "x": "383.45", "y": "290.45" }, { "x": "386.84", "y": "288.85" }, { "x": "386.78", "y": "288.68" }, { "x": "390.46", "y": "287.68" } ], [ { "x": "390.46", "y": "287.68" }, { "x": "394.35", "y": "286.68" }, { "x": "394.32", "y": "286.48" }, { "x": "398.40", "y": "285.68" } ], [ { "x": "398.40", "y": "285.68" }, { "x": "402.20", "y": "285.18" }, { "x": "402.30", "y": "284.94" }, { "x": "406.00", "y": "284.68" } ], [ { "x": "406.00", "y": "284.68" }, { "x": "409.80", "y": "295.18" }, { "x": "409.80", "y": "295.48" }, { "x": "413.60", "y": "305.68" } ], [ { "x": "413.60", "y": "305.68" }, { "x": "417.40", "y": "305.68" }, { "x": "417.40", "y": "305.48" }, { "x": "421.00", "y": "305.68" } ], [ { "x": "421.00", "y": "305.68" }, { "x": "424.77", "y": "293.68" }, { "x": "424.80", "y": "293.48" }, { "x": "428.80", "y": "281.68" } ], [ { "x": "428.80", "y": "281.68" }, { "x": "432.60", "y": "281.18" }, { "x": "432.60", "y": "280.94" }, { "x": "436.40", "y": "280.68" } ], [ { "x": "436.40", "y": "280.68" }, { "x": "440.80", "y": "280.68" }, { "x": "440.80", "y": "280.48" }, { "x": "445.00", "y": "280.68" } ] ], 
    "totalPoints": 50, 
    "totalCurves": 49 
};

// 处理贝塞尔曲线数据，转换为数值类型
const processedBezierCurves = userBezierData.bezierCurves.map(curve => {
    return curve.map(point => ({
        x: parseFloat(point.x),
        y: parseFloat(point.y)
    }));
});

// 绘制用户提供的复杂贝塞尔曲线
function drawDeleteMark(position, ctx) {
    ctx.strokeStyle = '#e74c3c'; // 红色曲线
    ctx.lineWidth = 2;
    ctx.beginPath();
    
    // 获取文本区域的位置和尺寸
    const textX = position.bounds.x;
    const textY = position.bounds.y;
    const textWidth = position.bounds.width;
    const textHeight = position.bounds.height;
    
    // 框的右上角坐标
    const boxRightTopX = textX + textWidth;
    const boxRightTopY = textY;
    
    // 计算曲线数据的边界
    let minX = Infinity, minY = Infinity;
    let maxX = -Infinity, maxY = -Infinity;
    
    processedBezierCurves.forEach(curve => {
        curve.forEach(point => {
            minX = Math.min(minX, point.x);
            minY = Math.min(minY, point.y);
            maxX = Math.max(maxX, point.x);
            maxY = Math.max(maxY, point.y);
        });
    });
    
    // 计算曲线尺寸
    const curveWidth = maxX - minX;
    const curveHeight = maxY - minY;
    
    // 缩放因子，放大5倍（原缩放因子是0.04，放大5倍后是0.2）
    const scale = 0.04 * 5; // 放大5倍
    
    // 计算偏移，将曲线左下角放到框的右上角
    // curve的左下角坐标是(minX, maxY)，我们需要将其移到(boxRightTopX, boxRightTopY)
    const offsetX = boxRightTopX - (minX * scale);
    const offsetY = boxRightTopY - (maxY * scale);
    
    // 绘制所有贝塞尔曲线
    processedBezierCurves.forEach((curve, index) => {
        const [p0, p1, p2, p3] = curve;
        
        if (index === 0) {
            // 第一段曲线，从p0开始
            ctx.moveTo(
                p0.x * scale + offsetX,
                p0.y * scale + offsetY
            );
        }
        
        // 绘制三次贝塞尔曲线
        ctx.bezierCurveTo(
            p1.x * scale + offsetX,
            p1.y * scale + offsetY,
            p2.x * scale + offsetX,
            p2.y * scale + offsetY,
            p3.x * scale + offsetX,
            p3.y * scale + offsetY
        );
    });
    
    ctx.stroke();
    console.log('绘制复杂贝塞尔曲线删除标记:', position);
}

// 导出删除绘制函数和相关数据
if (typeof module !== 'undefined' && module.exports) {
    module.exports = { drawDeleteMark };
} else {
    window.drawDeleteMark = drawDeleteMark;
}